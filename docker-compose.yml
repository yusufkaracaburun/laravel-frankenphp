services:
  # ─────────────────────────────────────────
  # Laravel App (FrankenPHP)
  # ─────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: docker/frankenphp/Dockerfile
    container_name: laravel_app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-80}:80"
      - "${APP_PORT_HTTPS:-443}:443"
      - "${APP_PORT_HTTPS:-443}:443/udp"  # HTTP/3 support
    environment:
      APP_ENV: "${APP_ENV:-local}"
      APP_KEY: "${APP_KEY}"
      APP_DEBUG: "${APP_DEBUG:-true}"
      APP_URL: "${APP_URL:-http://localhost}"
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: "${DB_DATABASE:-laravel}"
      DB_USERNAME: "${DB_USERNAME:-laravel}"
      DB_PASSWORD: "${DB_PASSWORD:-secret}"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      RUN_MIGRATIONS: "${RUN_MIGRATIONS:-true}"
    volumes:
      - .:/app
      - /app/vendor           # Exclude vendor from bind mount
      - /app/node_modules     # Exclude node_modules from bind mount
      - app_storage:/app/storage
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - laravel

  # ─────────────────────────────────────────
  # MySQL Database
  # ─────────────────────────────────────────
  mysql:
    image: mysql:8.0
    container_name: laravel_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_ROOT_PASSWORD:-rootsecret}"
      MYSQL_DATABASE: "${DB_DATABASE:-laravel}"
      MYSQL_USER: "${DB_USERNAME:-laravel}"
      MYSQL_PASSWORD: "${DB_PASSWORD:-secret}"
    ports:
      - "${FORWARD_DB_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-rootsecret}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - laravel

  # ─────────────────────────────────────────
  # Redis Cache & Queue
  # ─────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: laravel_redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "${FORWARD_REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - laravel

  # ─────────────────────────────────────────
  # phpMyAdmin (optional, dev only)
  # ─────────────────────────────────────────
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: laravel_phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_USER: root
      PMA_PASSWORD: "${DB_ROOT_PASSWORD:-rootsecret}"
      UPLOAD_LIMIT: 64M
    ports:
      - "${PHPMYADMIN_PORT:-8080}:80"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - laravel
    profiles:
      - dev

  # ─────────────────────────────────────────
  # Redis Commander (optional, dev only)
  # ─────────────────────────────────────────
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: laravel_redis_commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: "local:redis:6379"
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - laravel
    profiles:
      - dev

# ─────────────────────────────────────────
# Volumes
# ─────────────────────────────────────────
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  app_storage:
    driver: local

# ─────────────────────────────────────────
# Networks
# ─────────────────────────────────────────
networks:
  laravel:
    driver: bridge
